<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>透過PNG クリック判定</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        padding: 24px;
      }
      img {
        display: block;
        max-width: 100%;
        height: auto;
        cursor: default;
        user-select: none;
      }
      .img-wrapper {
        display: inline-block;
        margin: 10px;
      }
    </style>
  </head>
  <body>
    <h2>透過部分クリック無効（高速キャッシュ対応）</h2>

    <div class="img-wrapper">
      <img
        src="./PNG_transparency_demonstration_1.png"
        alt="画像1"
        data-href="https://example.com/1"
      />
    </div>
    <div class="img-wrapper">
      <img
        src="./png-2702691_640.webp"
        alt="画像2"
        data-href="https://example.com/2"
      />
    </div>

    <script>
      /**
       * 透過PNG画像のクリック判定クラス
       * アルファマップをキャッシュして高速なクリック判定を提供
       */
      class TransparentImageClickHandler {
        /**
         * @typedef {Object} ClickHandlerOptions
         * @property {number} [alphaThreshold=10] - アルファ値の閾値（0-255）
         * @property {string} [href] - クリック時の遷移先URL
         * @property {Function} [onClick] - クリック時のコールバック関数
         */

        /**
         * @typedef {Object} PixelCoordinate
         * @property {number} x - X座標
         * @property {number} y - Y座標
         */

        /**
         * コンストラクタ
         * @param {HTMLImageElement} img - 対象の画像要素
         * @param {ClickHandlerOptions} [options={}] - オプション設定
         */
        constructor(img, options = {}) {
          this.img = img;
          this.threshold = options.alphaThreshold ?? 10;
          this.href = options.href ?? img.dataset.href ?? null;
          this.onClick = options.onClick;

          this.hitmap = null;
          this.width = 0;
          this.height = 0;
          this.tainted = false;
          this.rafId = null;
          this.latestEvent = null;

          this.init();
        }

        /**
         * 初期化処理
         * @private
         */
        init() {
          if (this.img.complete && this.img.naturalWidth !== 0) {
            this.buildHitmap();
          } else {
            this.img.addEventListener("load", () => this.buildHitmap());
          }

          this.setupEventListeners();
        }

        /**
         * イベントリスナーの設定
         * @private
         */
        setupEventListeners() {
          this.img.addEventListener("pointermove", (evt) =>
            this.handleMove(evt)
          );
          this.img.addEventListener("pointerleave", () => this.resetCursor());
          this.img.addEventListener("click", (evt) => this.handleClick(evt));
        }

        /**
         * アルファマップを構築
         * @private
         */
        buildHitmap() {
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d", { willReadFrequently: true });

          this.width = this.img.naturalWidth;
          this.height = this.img.naturalHeight;
          canvas.width = this.width;
          canvas.height = this.height;

          try {
            ctx.drawImage(this.img, 0, 0, this.width, this.height);
            const imageData = ctx.getImageData(0, 0, this.width, this.height);
            this.hitmap = this.createHitmapFromImageData(imageData.data);
          } catch (error) {
            console.warn("Canvas tainted or image unreadable:", error);
            this.tainted = true;
            this.hitmap = null;
          }
        }

        /**
         * ImageDataからヒットマップを作成
         * @param {Uint8ClampedArray} data - ImageDataの配列
         * @returns {Uint8Array} ヒットマップ
         * @private
         */
        createHitmapFromImageData(data) {
          const hitmap = new Uint8Array(this.width * this.height);

          for (let i = 0, j = 3; j < data.length; i++, j += 4) {
            hitmap[i] = data[j] > this.threshold ? 1 : 0;
          }

          return hitmap;
        }

        /**
         * マウス位置から画像ピクセル座標を取得
         * @param {PointerEvent|TouchEvent} event - イベントオブジェクト
         * @returns {PixelCoordinate|null} ピクセル座標またはnull
         * @private
         */
        getPixelCoordinate(event) {
          const rect = this.img.getBoundingClientRect();
          const clientX = event.clientX ?? event.touches?.[0]?.clientX;
          const clientY = event.clientY ?? event.touches?.[0]?.clientY;

          if (clientX == null || clientY == null) return null;

          const x = Math.floor(
            (clientX - rect.left) * (this.width / rect.width)
          );
          const y = Math.floor(
            (clientY - rect.top) * (this.height / rect.height)
          );

          if (x < 0 || y < 0 || x >= this.width || y >= this.height) {
            return null;
          }

          return { x, y };
        }

        /**
         * 指定座標のピクセルが不透明かどうかを判定
         * @param {number} x - X座標
         * @param {number} y - Y座標
         * @returns {boolean} 不透明な場合true
         * @private
         */
        isOpaqueAt(x, y) {
          if (this.tainted) return true; // フォールバック
          if (!this.hitmap) return false;
          return this.hitmap[y * this.width + x] === 1;
        }

        /**
         * マウス移動イベントのハンドラ（requestAnimationFrameで最適化）
         * @param {PointerEvent} event - ポインターイベント
         * @private
         */
        handleMove(event) {
          this.latestEvent = event;

          if (!this.rafId) {
            this.rafId = requestAnimationFrame(() => {
              this.rafId = null;
              if (!this.latestEvent) return;

              const coordinate = this.getPixelCoordinate(this.latestEvent);
              if (!coordinate) return;

              const isOpaque = this.isOpaqueAt(coordinate.x, coordinate.y);
              this.setCursor(isOpaque ? "pointer" : "default");
            });
          }
        }

        /**
         * クリックイベントのハンドラ
         * @param {PointerEvent} event - ポインターイベント
         * @private
         */
        handleClick(event) {
          const coordinate = this.getPixelCoordinate(event);
          if (!coordinate) return;

          if (this.isOpaqueAt(coordinate.x, coordinate.y)) {
            this.executeClickAction(event);
          } else {
            this.preventClickPropagation(event);
          }
        }

        /**
         * クリックアクションを実行
         * @param {PointerEvent} event - ポインターイベント
         * @private
         */
        executeClickAction(event) {
          if (this.onClick) {
            this.onClick(event);
          } else if (this.href) {
            window.location.href = this.href;
          }
        }

        /**
         * クリックイベントの伝播を防ぐ
         * @param {PointerEvent} event - ポインターイベント
         * @private
         */
        preventClickPropagation(event) {
          event.preventDefault();
          event.stopPropagation();
        }

        /**
         * カーソルスタイルを設定
         * @param {string} cursor - カーソルスタイル
         * @private
         */
        setCursor(cursor) {
          this.img.style.cursor = cursor;
        }

        /**
         * カーソルをデフォルトに戻す
         * @private
         */
        resetCursor() {
          this.setCursor("default");
        }

        /**
         * イベントリスナーを削除してクリーンアップ
         * @public
         */
        destroy() {
          if (this.rafId) {
            cancelAnimationFrame(this.rafId);
            this.rafId = null;
          }

          this.img.removeEventListener("pointermove", this.handleMove);
          this.img.removeEventListener("pointerleave", this.resetCursor);
          this.img.removeEventListener("click", this.handleClick);

          this.hitmap = null;
          this.latestEvent = null;
        }
      }

      /**
       * 画像要素に透過クリック判定を設定するヘルパー関数
       * @param {HTMLImageElement} img - 対象の画像要素
       * @param {ClickHandlerOptions} [options={}] - オプション設定
       * @returns {TransparentImageClickHandler} ハンドラーインスタンス
       */
      function setupClickableImage(img, options = {}) {
        return new TransparentImageClickHandler(img, options);
      }

      // ==== 使用例 ====
      document.addEventListener("DOMContentLoaded", () => {
        const images = document.querySelectorAll("img");

        images.forEach((img) => {
          setupClickableImage(img, {
            alphaThreshold: 10,
            onClick: (event) => {
              const url = event.target.dataset.href;
              const alt = event.target.alt;

              if (url) {
                alert(`"${alt}" をクリック → ${url}`);
                window.location.href = url;
              }
            },
          });
        });
      });
    </script>
  </body>
</html>
